language: 
  node_js
services:
  - docker
  # - mongodb
  # - redis-server
node_js:
  - '12'
branches:
  only:
  - master
addons:
  ssh_known_hosts: $ip
before_install:
  - openssl aes-256-cbc -K $encrypted_cee67c79dec3_key -iv $encrypted_cee67c79dec3_iv
    -in id_rsa.enc -out ~/.ssh/id_rsa -d
  - chmod 600 ~/.ssh/id_rsa
install:
  # - npm install -g mocha
  # - npm install
  # 启动docker
  - docker build -t registry.cn-hangzhou.aliyuncs.com/movie-node/node-server:latest .
before_script:
  - sleep 15
script:
  - npm run test
after_success:
  - echo 'I successfully done'
  # - npm i -g pm2
  # - pm2 deploy pm2.config.js production update
  - sudo docker login --username=$username -p=$aliyun_pwd registry.cn-hangzhou.aliyuncs.com
  - sudo docker push registry.cn-hangzhou.aliyuncs.com/movie-node/node-server:latest
  - ssh -o "StrictHostKeyChecking no" -i ~/.ssh/id_rsa root@$ip "cd /home/server/source;docker-compose -f docker-compose.yml pull;docker-compose -f docker-compose.yml up -d;exit"